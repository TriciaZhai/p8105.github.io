<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Cross Validation</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
<script defer src="https://use.fontawesome.com/releases/v5.0.3/js/all.js"></script>
<script defer src="https://use.fontawesome.com/releases/v5.0.0/js/v4-shims.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">P8105</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="schedule.html">Schedule</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="topic_what_is_data_science.html">What is Data Science?</a>
    </li>
    <li>
      <a href="topic_building_blocks.html">Building Blocks</a>
    </li>
    <li>
      <a href="topic_data_wrangling_i.html">Data Wrangling I</a>
    </li>
    <li>
      <a href="topic_visualization_and_eda.html">Visualization and EDA</a>
    </li>
    <li>
      <a href="topic_data_wrangling_ii.html">Data Wrangling II</a>
    </li>
    <li>
      <a href="topic_interactivity.html">Interactivity</a>
    </li>
    <li>
      <a href="topic_iteration.html">Iteration</a>
    </li>
    <li>
      <a href="topic_linear_models.html">Linear Models</a>
    </li>
    <li>
      <a href="topic_other_material.html">Other Materials</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Datasets
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="dataset_airbnb.html">Airbnb</a>
    </li>
    <li>
      <a href="dataset_brfss.html">BRFSS</a>
    </li>
    <li>
      <a href="dataset_fivethirtyeight.html">FiveThirtyEight</a>
    </li>
    <li>
      <a href="dataset_instacart.html">Instacart</a>
    </li>
    <li>
      <a href="dataset_mr_trash_wheel.html">Mr. Trash Wheel</a>
    </li>
    <li>
      <a href="dataset_noaa.html">NOAA</a>
    </li>
    <li>
      <a href="dataset_restaurant_inspections.html">NYC Restaurant Inspections</a>
    </li>
  </ul>
</li>
<li>
  <a href="homework_and_projects.html">Homework and Projects</a>
</li>
<li>
  <a href="course_communication.html">Communication</a>
</li>
<li>
  <a href="https://github.com/P8105/p8105.github.io">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Cross Validation</h1>

</div>


<p>Although hypothesis tests provide a way to compare nested linear models, in many situations the approaches under consideration don’t fit nicely in this paradigm. Indeed, for many modern tools and in many applications, the emphasis lies on prediction accuracy rather than on statistical significance. In these cases, cross validation provides a way to compare the predictive performance of competing methods.</p>
<p>This is the second module in the <a href="topic_iteration.html">Linear Models</a> topic; the relevant slack channel is <a href="https://p8105-fall2018.slack.com/messages/CCAAE9AAU">here</a>.</p>
<div id="some-slides" class="section level2">
<h2>Some slides</h2>
<script async class="speakerdeck-embed" data-id="285289b17d194a4282d53f1800d37199" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>
<div style="margin-bottom:5px">
<strong> <a href="https://speakerdeck.com/jeffgoldsmith/p8105-cross-validation" title="Cross validation" target="_blank">Cross validation</a> </strong> from <strong><a href="https://speakerdeck.com/jeffgoldsmith" target="_blank">Jeff Goldsmith</a></strong>.
</div>
<p><br></p>
</div>
<div id="example" class="section level2">
<h2>Example</h2>
<p>I’ll write code for today’s content in a new R Markdown document called <code>simulation.Rmd</code> in the <code>iteration</code> directory / repo. The code chunk below loads the usual packages and sets a seed for reproducibility.</p>
<pre class="r"><code>library(tidyverse)
library(modelr)
library(mgcv)
## Loading required package: nlme
## 
## Attaching package: &#39;nlme&#39;
## The following object is masked from &#39;package:dplyr&#39;:
## 
##     collapse
## This is mgcv 1.8-24. For overview type &#39;help(&quot;mgcv-package&quot;)&#39;.

set.seed(1)</code></pre>
<div id="cv-by-hand" class="section level3">
<h3>CV by hand</h3>
<pre class="r"><code>nonlin_df = tibble(
  id = 1:100,
  x = runif(100, 0, 1),
  y = 1 - 10 * (x - .3) ^ 2 + rnorm(100, 0, .3)
)

ggplot(nonlin_df, aes(x = x, y = y)) + geom_point() + theme_bw()</code></pre>
<p><img src="cross_validation_files/figure-html/unnamed-chunk-3-1.png" width="90%" /></p>
<pre class="r"><code>train_df = sample_n(nonlin_df, 80)
test_df = anti_join(nonlin_df, train_df, by = &quot;id&quot;)</code></pre>
<pre class="r"><code>lin_mod = lm(y ~ x, data = train_df)
nonlin_mod = mgcv::gam(y ~ s(x), data = train_df)
wiggly_mod = mgcv::gam(y ~ s(x, k = 30), sp = 10e-6, data = train_df)</code></pre>
<p>gam is weird, let’s see some fits</p>
<pre class="r"><code>train_df %&gt;% 
  add_predictions(nonlin_mod) %&gt;% 
  ggplot(aes(x = x, y = y)) + geom_point() + 
  geom_line(aes(y = pred), color = &quot;red&quot;)</code></pre>
<p><img src="cross_validation_files/figure-html/unnamed-chunk-6-1.png" width="90%" /></p>
<pre class="r"><code>
train_df %&gt;% 
  add_predictions(wiggly_mod) %&gt;% 
  ggplot(aes(x = x, y = y)) + geom_point() + 
  geom_line(aes(y = pred), color = &quot;red&quot;)</code></pre>
<p><img src="cross_validation_files/figure-html/unnamed-chunk-6-2.png" width="90%" /></p>
<pre class="r"><code>rmse(lin_mod, test_df)
## [1] 0.7163422
rmse(nonlin_mod, test_df)
## [1] 0.2437012
rmse(wiggly_mod, test_df)
## [1] 0.3471883</code></pre>
</div>
<div id="cv-using-modelr" class="section level3">
<h3>CV using <code>modelr</code></h3>
<pre class="r"><code>cv_df = 
  crossv_mc(nonlin_df, 100) 

cv_df %&gt;% pull(train) %&gt;% .[[1]] %&gt;% as_tibble
## # A tibble: 79 x 3
##       id     x       y
##    &lt;int&gt; &lt;dbl&gt;   &lt;dbl&gt;
##  1     1 0.266  1.11  
##  2     2 0.372  0.764 
##  3     3 0.573  0.358 
##  4     5 0.202  1.33  
##  5     7 0.945 -3.27  
##  6     8 0.661 -0.615 
##  7     9 0.629  0.0878
##  8    11 0.206  1.63  
##  9    12 0.177  0.836 
## 10    14 0.384  0.938 
## # ... with 69 more rows
cv_df %&gt;% pull(test) %&gt;% .[[1]] %&gt;% as_tibble
## # A tibble: 21 x 3
##       id      x       y
##    &lt;int&gt;  &lt;dbl&gt;   &lt;dbl&gt;
##  1     4 0.908  -3.04  
##  2     6 0.898  -1.99  
##  3    10 0.0618  0.392 
##  4    13 0.687  -0.291 
##  5    15 0.770  -1.43  
##  6    17 0.718  -1.29  
##  7    23 0.652  -0.0535
##  8    42 0.647   0.158 
##  9    46 0.789  -1.23  
## 10    50 0.693  -0.684 
## # ... with 11 more rows</code></pre>
<pre class="r"><code>cv_df =
  cv_df %&gt;% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))</code></pre>
<pre class="r"><code>cv_df = 
  cv_df %&gt;% 
  mutate(lin_mod = map(train, ~lm(y ~ x, data = .x)),
         nonlin_mod = map(train, ~mgcv::gam(y ~ s(x), data = .x)),
         wiggly_mod = map(train, ~gam(y ~ s(x, k = 30), sp = 10e-6, data = .x))) %&gt;% 
  mutate(rmse_lin    = map2_dbl(lin_mod, test, ~rmse(model = .x, data = .y)),
         rmse_nonlin = map2_dbl(nonlin_mod, test, ~rmse(model = .x, data = .y)),
         rmse_wiggly = map2_dbl(wiggly_mod, test, ~rmse(model = .x, data = .y)))</code></pre>
<pre class="r"><code>cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  gather(key = model, value = rmse) %&gt;% 
  mutate(model = str_replace(model, &quot;rmse_&quot;, &quot;&quot;),
         model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()</code></pre>
<p><img src="cross_validation_files/figure-html/unnamed-chunk-11-1.png" width="90%" /></p>
</div>
<div id="nepalese-children" class="section level3">
<h3>Nepalese children</h3>
<pre class="r"><code>child_growth = read_csv(&quot;./data/nepalese_children.csv&quot;)
## Parsed with column specification:
## cols(
##   id = col_integer(),
##   age = col_integer(),
##   sex = col_integer(),
##   weight = col_double(),
##   height = col_double(),
##   armc = col_double()
## )</code></pre>
<pre class="r"><code>child_growth %&gt;% 
  ggplot(aes(x = weight, y = armc)) + 
  geom_point(alpha = .5)</code></pre>
<p><img src="cross_validation_files/figure-html/unnamed-chunk-13-1.png" width="90%" /></p>
<pre class="r"><code>child_growth =
  child_growth %&gt;% 
  mutate(weight_sp = (weight &gt; 7) * (weight - 7))</code></pre>
<pre class="r"><code>lin_mod = lm(armc ~ weight, data = child_growth)
pwl_mod = lm(armc ~ weight + weight_sp, data = child_growth)
nonlin_mod = gam(armc ~ s(weight), data = child_growth)</code></pre>
<pre class="r"><code>child_growth %&gt;% 
  gather_predictions(lin_mod, pwl_mod, nonlin_mod) %&gt;% 
  mutate(model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = weight, y = armc)) + 
  geom_point(alpha = .5) +
  geom_line(aes(y = pred), color = &quot;red&quot;) + 
  facet_grid(~model)</code></pre>
<p><img src="cross_validation_files/figure-html/unnamed-chunk-16-1.png" width="90%" /></p>
<pre class="r"><code>cv_df =
  crossv_mc(child_growth, 100) %&gt;% 
  mutate(train = map(train, as_tibble),
         test = map(test, as_tibble))</code></pre>
<pre class="r"><code>cv_df = 
  cv_df %&gt;% 
  mutate(lin_mod = map(train, ~lm(armc ~ weight, data = .x)),
         pwl_mod = map(train, ~lm(armc ~ weight + weight_sp, data = .x)),
         nonlin_mod = map(train, ~gam(armc ~ s(weight), data = as_tibble(.x)))) %&gt;% 
  mutate(rmse_lin    = map2_dbl(lin_mod, test, ~rmse(model = .x, data = .y)),
         rmse_pwl = map2_dbl(pwl_mod, test, ~rmse(model = .x, data = .y)),
         rmse_nonlin = map2_dbl(nonlin_mod, test, ~rmse(model = .x, data = .y)))</code></pre>
<pre class="r"><code>cv_df %&gt;% 
  select(starts_with(&quot;rmse&quot;)) %&gt;% 
  gather(key = model, value = rmse) %&gt;% 
  mutate(model = str_replace(model, &quot;rmse_&quot;, &quot;&quot;),
         model = fct_inorder(model)) %&gt;% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()</code></pre>
<p><img src="cross_validation_files/figure-html/unnamed-chunk-19-1.png" width="90%" /></p>
</div>
<div id="real-example" class="section level3">
<h3>real example</h3>
<pre class="r"><code>

## penalized spline
fx = gam(armc ~ s(weight), data = data.train)
plot.fx = data.frame(weight = data.train$weight, fx = fitted(fx))
p1 + geom_line(data = plot.fx, aes(x = weight, y = fx, color = NULL), color = &quot;blue&quot;, size = 1.5)

CV[5] = mean((data.valid$armc - predict(fx, newdata = data.valid))^2)


## kernel smoother
plot.fx = with(data.train, as.data.frame(ksmooth(weight, armc, kernel = &quot;normal&quot;, bandwidth = 2)))
p1 + geom_line(data = plot.fx, aes(x = x, y = y, color = NULL), color = &quot;blue&quot;, size = 1.5)

fx.cv = with(data.train, ksmooth(weight, armc, kernel = &quot;normal&quot;, bandwidth = 2, x.points = data.valid$weight)$y)
CV[6] = mean((data.valid$armc[order(data.valid$weight)] - fx.cv)^2)


## compare CV
CV = data.frame(x = 1:6, CV = CV)
ggplot(CV, aes(x = x, y = CV)) + geom_point() + geom_line() + labs(x = &quot;&quot;) + 
  scale_x_continuous(breaks = 1:6, labels = c(&quot;Obs Mean&quot;, &quot;SLR&quot;, &quot;Poly&quot;, &quot;Spline&quot;, &quot;P-Spline&quot;, &quot;Kernel&quot;)) + 
  theme_bw()


####################################################################
## extended case study of arm circumference
####################################################################

## penalized spline
fx = gam(armc ~ s(weight), data = data.train)
plot.fx = data.frame(weight = data.train$weight, fx = fitted(fx))
p1 + geom_line(data = plot.fx, aes(x = weight, y = fx, color = NULL), color = &quot;blue&quot;, size = 1.5)
summary(fx)

## penalized spline -- different penalty and spline basis
fx = gam(armc ~ s(weight, k = 100), data = data.train, sp = (.0001))
plot.fx = data.frame(weight = data.train$weight, fx = fitted(fx))
p1 + geom_line(data = plot.fx, aes(x = weight, y = fx, color = NULL), color = &quot;blue&quot;, size = 1.5)
summary(fx)


## separate boys and girls
ggplot(data.train, aes(x = weight, y = armc, color = as.factor(sex))) + geom_point(alpha = .2) +
  scale_color_manual(values = c(&quot;blue&quot;, &quot;red&quot;), guide = FALSE) +
  stat_smooth(method = &quot;gam&quot;, formula = y ~ s(x), se = FALSE, size = 1.5) + 
  theme_bw()

fx = gam(armc ~ sex + sex * weight + s(weight), data = data.train) 
summary(fx)
summary(lm(armc ~ sex + sex * weight, data = data.train))

plot(fx)

## separate age groups
data.train = mutate(data.train, ageGroup = cut(age, breaks = c(0, 22, 32, 40, 50, 100), labels = 1:5))
data.valid = mutate(data.valid, ageGroup = cut(age, breaks = c(0, 22, 32, 40, 50, 100), labels = 1:5))

ggplot(data.train, aes(x = weight, y = armc, color = ageGroup)) + geom_point(alpha = .2) +
  stat_smooth(method = &quot;gam&quot;, formula = y ~ s(x), se = FALSE, size = 1.5) + 
  scale_color_discrete(guide = FALSE) + 
  theme_bw()

## smooth effects of age and weight
fx = gam(armc ~ s(age) + s(weight), data = data.train) 
summary(fx)

CV[7,] = c(7, mean((data.valid$armc - predict(fx, newdata = data.valid))^2))

par(mfrow = c(1,2))
plot(fx)

## linear model for comparison
fx = lm(armc ~ age + weight, data = data.train)
summary(fx)

CV[8,] = c(8, mean((data.valid$armc - predict(fx, newdata = data.valid))^2))


## compare CV
ggplot(CV, aes(x = x, y = CV)) + geom_point() + geom_line() + labs(x = &quot;&quot;) + 
  scale_x_continuous(breaks = 1:8, labels = c(&quot;Obs Mean&quot;, &quot;SLR&quot;, &quot;Poly&quot;, &quot;Spline&quot;, &quot;P-Spline&quot;, &quot;Kernel&quot;, &quot;Smooth&quot;, &quot;MLR&quot;)) + 
  theme_bw()
</code></pre>
</div>
</div>
<div id="other-materials" class="section level2">
<h2>Other materials</h2>
<ul>
<li>We didn’t discuss cross validation, another popular approach, but you can read up on it <a href="https://drsimonj.svbtle.com/k-fold-cross-validation-with-modelr-and-broom">here</a> and <a href="http://rpubs.com/dgrtwo/cv-modelr">here</a></li>
</ul>
<p>The code that I produced working examples in lecture is <a href="https://github.com/P8105/linear_models">here</a>.</p>
</div>

<br><br>
<footer>
  <img src="images/p8105_stickers.png" alt="stickers" style="width:30%">
  <br>
  <p class="copyright text-muted" align="center">Copyright &copy; 2018 Jeff Goldsmith</p>
</footer>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
