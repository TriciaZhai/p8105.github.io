<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />




<title>Linear models</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="site_libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="site_libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>
<link href="site_libs/font-awesome-5.0.13/css/fa-svg-with-js.css" rel="stylesheet" />
<script src="site_libs/font-awesome-5.0.13/js/fontawesome-all.min.js"></script>
<script src="site_libs/font-awesome-5.0.13/js/fa-v4-shims.min.js"></script>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css" />
<script defer src="https://use.fontawesome.com/releases/v5.0.3/js/all.js"></script>
<script defer src="https://use.fontawesome.com/releases/v5.0.0/js/v4-shims.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />

</head>

<body>

<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}

.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>


<div class="container-fluid main-container">

<!-- tabsets -->
<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});
</script>

<!-- code folding -->




<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_').toLowerCase();
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}


.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
  padding-left: 25px;
  text-indent: 0;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>

<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row-fluid">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">P8105</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="schedule.html">Schedule</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="topic_what_is_data_science.html">What is Data Science?</a>
    </li>
    <li>
      <a href="topic_building_blocks.html">Building Blocks</a>
    </li>
    <li>
      <a href="topic_data_wrangling_i.html">Data Wrangling I</a>
    </li>
    <li>
      <a href="topic_visualization_and_eda.html">Visualization and EDA</a>
    </li>
    <li>
      <a href="topic_data_wrangling_ii.html">Data Wrangling II</a>
    </li>
    <li>
      <a href="topic_interactivity.html">Interactivity</a>
    </li>
    <li>
      <a href="topic_iteration.html">Iteration</a>
    </li>
    <li>
      <a href="topic_linear_models.html">Linear Models</a>
    </li>
    <li>
      <a href="topic_other_material.html">Other Materials</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Datasets
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="dataset_airbnb.html">Airbnb</a>
    </li>
    <li>
      <a href="dataset_brfss.html">BRFSS</a>
    </li>
    <li>
      <a href="dataset_fivethirtyeight.html">FiveThirtyEight</a>
    </li>
    <li>
      <a href="dataset_instacart.html">Instacart</a>
    </li>
    <li>
      <a href="dataset_mr_trash_wheel.html">Mr. Trash Wheel</a>
    </li>
    <li>
      <a href="dataset_noaa.html">NOAA</a>
    </li>
    <li>
      <a href="dataset_restaurant_inspections.html">NYC Restaurant Inspections</a>
    </li>
  </ul>
</li>
<li>
  <a href="homework_and_projects.html">Homework and Projects</a>
</li>
<li>
  <a href="course_communication.html">Communication</a>
</li>
<li>
  <a href="https://github.com/P8105/p8105.github.io">
    <span class="fa fa-github"></span>
     
  </a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Linear models</h1>

</div>


<p>Linear regression models are fundamental in statistics and data science. When seeking to understand how covariates are associated with outcomes, linear models are among the first, best options. Although other regression approaches are possible, the flexibility and interpretability and of linear models make them essential.</p>
<p>This is the first module in the <a href="topic_linear_models.html">Linear Models</a> topic; the relevant slack channel is <a href="https://p8105-fall2018.slack.com/messages/CCAAE9AAU">here</a>.</p>
<div id="some-slides" class="section level2">
<h2>Some slides</h2>
<script async class="speakerdeck-embed" data-id="285289b17d194a4282d53f1800d37199" data-ratio="1.77777777777778" src="//speakerdeck.com/assets/embed.js"></script>
<div style="margin-bottom:5px">
<strong> <a href="https://speakerdeck.com/jeffgoldsmith/p8105-simulation" title="Simulation and Bootstrapping" target="_blank">Simulation</a> </strong> from <strong><a href="https://speakerdeck.com/jeffgoldsmith" target="_blank">Jeff Goldsmith</a></strong>.
</div>
<p><br></p>
</div>
<div id="example" class="section level2">
<h2>Example</h2>
<p>I’ll write code for today’s content in a new R Markdown document called <code>linear_models.Rmd</code> in a <code>linear_models</code> directory / repo. The code chunk below loads the usual packages and sets a seed for reproducibility.</p>
<pre class="r"><code>library(tidyverse)
library(p8105.datasets)

set.seed(1)</code></pre>
<div id="model-fitting" class="section level3">
<h3>Model fitting</h3>
<pre class="r"><code>data(&quot;nyc_airbnb&quot;)

nyc_airbnb = 
  nyc_airbnb %&gt;% 
  mutate(stars = review_scores_location / 2) %&gt;% 
  rename(boro = neighbourhood_group,
         neighborhood = neighbourhood) %&gt;% 
  filter(boro != &quot;Staten Island&quot;) %&gt;% 
  select(price, stars, boro, neighborhood, room_type)</code></pre>
<pre class="r"><code>fit = lm(price ~ stars + boro, data = nyc_airbnb)
summary(fit)
## 
## Call:
## lm(formula = price ~ stars + boro, data = nyc_airbnb)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -169.8  -64.0  -29.0   20.2 9870.0 
## 
## Coefficients:
##               Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    -70.414     14.021  -5.022 5.14e-07 ***
## stars           31.990      2.527  12.657  &lt; 2e-16 ***
## boroBrooklyn    40.500      8.559   4.732 2.23e-06 ***
## boroManhattan   90.254      8.567  10.534  &lt; 2e-16 ***
## boroQueens      13.206      9.065   1.457    0.145    
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 181.5 on 30525 degrees of freedom
##   (9962 observations deleted due to missingness)
## Multiple R-squared:  0.03423,    Adjusted R-squared:  0.03411 
## F-statistic: 270.5 on 4 and 30525 DF,  p-value: &lt; 2.2e-16</code></pre>
<pre class="r"><code>nyc_airbnb = 
  nyc_airbnb %&gt;% 
  mutate(boro = fct_infreq(boro),
         room_type = fct_infreq(room_type))

fit = lm(price ~ stars + boro, data = nyc_airbnb)
summary(fit)
## 
## Call:
## lm(formula = price ~ stars + boro, data = nyc_airbnb)
## 
## Residuals:
##    Min     1Q Median     3Q    Max 
## -169.8  -64.0  -29.0   20.2 9870.0 
## 
## Coefficients:
##              Estimate Std. Error t value Pr(&gt;|t|)    
## (Intercept)    19.839     12.189   1.628    0.104    
## stars          31.990      2.527  12.657   &lt;2e-16 ***
## boroBrooklyn  -49.754      2.235 -22.262   &lt;2e-16 ***
## boroQueens    -77.048      3.727 -20.675   &lt;2e-16 ***
## boroBronx     -90.254      8.567 -10.534   &lt;2e-16 ***
## ---
## Signif. codes:  0 &#39;***&#39; 0.001 &#39;**&#39; 0.01 &#39;*&#39; 0.05 &#39;.&#39; 0.1 &#39; &#39; 1
## 
## Residual standard error: 181.5 on 30525 degrees of freedom
##   (9962 observations deleted due to missingness)
## Multiple R-squared:  0.03423,    Adjusted R-squared:  0.03411 
## F-statistic: 270.5 on 4 and 30525 DF,  p-value: &lt; 2.2e-16</code></pre>
</div>
<div id="tidying-output" class="section level3">
<h3>Tidying output</h3>
<pre class="r"><code>fit %&gt;% 
  broom::glance()
## # A tibble: 1 x 11
##   r.squared adj.r.squared sigma statistic   p.value    df  logLik    AIC
## *     &lt;dbl&gt;         &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt;
## 1    0.0342        0.0341  182.      271. 6.73e-229     5 -2.02e5 4.04e5
## # ... with 3 more variables: BIC &lt;dbl&gt;, deviance &lt;dbl&gt;, df.residual &lt;int&gt;</code></pre>
<pre class="r"><code>fit %&gt;% 
  broom::tidy() %&gt;% 
  select(term, estimate, p.value) %&gt;% 
  mutate(term = str_replace(term, &quot;^boro&quot;, &quot;Boro: &quot;)) %&gt;% 
  knitr::kable(digits = 3)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">estimate</th>
<th align="right">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">19.839</td>
<td align="right">0.104</td>
</tr>
<tr class="even">
<td align="left">stars</td>
<td align="right">31.990</td>
<td align="right">0.000</td>
</tr>
<tr class="odd">
<td align="left">Boro: Brooklyn</td>
<td align="right">-49.754</td>
<td align="right">0.000</td>
</tr>
<tr class="even">
<td align="left">Boro: Queens</td>
<td align="right">-77.048</td>
<td align="right">0.000</td>
</tr>
<tr class="odd">
<td align="left">Boro: Bronx</td>
<td align="right">-90.254</td>
<td align="right">0.000</td>
</tr>
</tbody>
</table>
<p><code>broom::tidy</code> works with lots of things…</p>
</div>
<div id="diagnostics" class="section level3">
<h3>Diagnostics</h3>
<pre class="r"><code>nyc_airbnb %&gt;% 
  modelr::add_residuals(fit) %&gt;% 
  modelr::add_predictions(fit)
## # A tibble: 40,492 x 7
##    price stars boro  neighborhood room_type        resid  pred
##    &lt;int&gt; &lt;dbl&gt; &lt;fct&gt; &lt;chr&gt;        &lt;fct&gt;            &lt;dbl&gt; &lt;dbl&gt;
##  1    99   5   Bronx City Island  Private room      9.47  89.5
##  2   200  NA   Bronx City Island  Private room     NA     NA  
##  3   300  NA   Bronx City Island  Entire home/apt  NA     NA  
##  4   125   5   Bronx City Island  Entire home/apt  35.5   89.5
##  5    69   5   Bronx City Island  Private room    -20.5   89.5
##  6   125   5   Bronx City Island  Entire home/apt  35.5   89.5
##  7    85   5   Bronx City Island  Entire home/apt  -4.53  89.5
##  8    39   4.5 Bronx Allerton     Private room    -34.5   73.5
##  9    95   5   Bronx Allerton     Entire home/apt   5.47  89.5
## 10   125   4.5 Bronx Allerton     Entire home/apt  51.5   73.5
## # ... with 40,482 more rows</code></pre>
<pre class="r"><code>nyc_airbnb %&gt;% 
  modelr::add_residuals(fit) %&gt;% 
  ggplot(aes(x = boro, y = resid)) + geom_violin()
## Warning: Removed 9962 rows containing non-finite values (stat_ydensity).</code></pre>
<p><img src="linear_models_files/figure-html/unnamed-chunk-9-1.png" width="90%" /></p>
<pre class="r"><code>
nyc_airbnb %&gt;% 
  modelr::add_residuals(fit) %&gt;% 
  ggplot(aes(x = stars, y = resid)) + geom_point()
## Warning: Removed 9962 rows containing missing values (geom_point).</code></pre>
<p><img src="linear_models_files/figure-html/unnamed-chunk-9-2.png" width="90%" /></p>
<p>Huge outliers / skewed distribution!! Should we exclude? Transform …? Use a “robust” regression???</p>
<p>For now I’m gonna ignore this, although it is definitely a problem.</p>
</div>
<div id="hypothesis-testing" class="section level3">
<h3>Hypothesis testing</h3>
<p>Testing a single coef is pretty easy – it’s right there in the output.</p>
<p>Comparing nested models</p>
<pre class="r"><code>fit_null = lm(price ~ stars + boro, data = nyc_airbnb)
fit_alt = lm(price ~ stars + boro + room_type, data = nyc_airbnb)

anova(fit_null, fit_alt) %&gt;% 
  broom::tidy()
## Warning: Unknown or uninitialised column: &#39;term&#39;.
## # A tibble: 2 x 6
##   res.df         rss    df     sumsq statistic p.value
## *  &lt;dbl&gt;       &lt;dbl&gt; &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;
## 1  30525 1005601724.    NA       NA        NA       NA
## 2  30523  921447496.     2 84154228.     1394.       0</code></pre>
<p>This works for nested models only</p>
</div>
<div id="nesting-data" class="section level3">
<h3>Nesting data</h3>
<p>(not nesting models – sorry)</p>
<p>This is confusing</p>
<pre class="r"><code>nyc_airbnb %&gt;% 
  lm(price ~ stars * boro + room_type * boro, data = .)
## 
## Call:
## lm(formula = price ~ stars * boro + room_type * boro, data = .)
## 
## Coefficients:
##                        (Intercept)                               stars  
##                             95.694                              27.110  
##                       boroBrooklyn                          boroQueens  
##                            -26.066                              -4.118  
##                          boroBronx               room_typePrivate room  
##                             -5.627                            -124.188  
##               room_typeShared room                  stars:boroBrooklyn  
##                           -153.635                              -6.139  
##                   stars:boroQueens                     stars:boroBronx  
##                            -17.455                             -22.664  
## boroBrooklyn:room_typePrivate room    boroQueens:room_typePrivate room  
##                             31.965                              54.933  
##    boroBronx:room_typePrivate room   boroBrooklyn:room_typeShared room  
##                             71.273                              47.797  
##    boroQueens:room_typeShared room      boroBronx:room_typeShared room  
##                             58.662                              83.089</code></pre>
<p>This is clearer</p>
<pre class="r"><code>nest_lm_res =
  nyc_airbnb %&gt;% 
  group_by(boro) %&gt;% 
  nest() %&gt;% 
  mutate(models = map(data, ~lm(price ~ stars + room_type, data = .x)),
         models = map(models, broom::tidy)) %&gt;% 
  select(-data) %&gt;% 
  unnest()

nest_lm_res %&gt;% 
  select(boro, term, estimate) %&gt;% 
  mutate(term = fct_inorder(term)) %&gt;% 
  spread(key = term, value = estimate) %&gt;% 
  knitr::kable(digits = 3)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">boro</th>
<th align="right">(Intercept)</th>
<th align="right">stars</th>
<th align="right">room_typePrivate room</th>
<th align="right">room_typeShared room</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Manhattan</td>
<td align="right">95.694</td>
<td align="right">27.110</td>
<td align="right">-124.188</td>
<td align="right">-153.635</td>
</tr>
<tr class="even">
<td align="left">Brooklyn</td>
<td align="right">69.627</td>
<td align="right">20.971</td>
<td align="right">-92.223</td>
<td align="right">-105.839</td>
</tr>
<tr class="odd">
<td align="left">Queens</td>
<td align="right">91.575</td>
<td align="right">9.654</td>
<td align="right">-69.255</td>
<td align="right">-94.973</td>
</tr>
<tr class="even">
<td align="left">Bronx</td>
<td align="right">90.067</td>
<td align="right">4.446</td>
<td align="right">-52.915</td>
<td align="right">-70.547</td>
</tr>
</tbody>
</table>
<p>tradeoff: nesting gives you separate models, which is an easy-to-interpret way to examine effect modification in an exploratory way. But it <em>doesn’t</em> give a way to test.</p>
<p>Even more extreme:</p>
<pre class="r"><code>manhattan_airbnb =
  nyc_airbnb %&gt;% 
  filter(boro == &quot;Manhattan&quot;)

manhattan_airbnb %&gt;% 
  count(neighborhood)
## # A tibble: 32 x 2
##    neighborhood           n
##    &lt;chr&gt;              &lt;int&gt;
##  1 Battery Park City     65
##  2 Chelsea             1072
##  3 Chinatown            360
##  4 Civic Center          42
##  5 East Harlem         1048
##  6 East Village        1858
##  7 Financial District   391
##  8 Flatiron District     90
##  9 Gramercy             307
## 10 Greenwich Village    383
## # ... with 22 more rows

manhattan_nest_lm_res =
  manhattan_airbnb %&gt;% 
  group_by(neighborhood) %&gt;% 
  nest() %&gt;% 
  mutate(models = map(data, ~lm(price ~ stars + room_type, data = .x)),
         models = map(models, broom::tidy)) %&gt;% 
  select(-data) %&gt;% 
  unnest()

manhattan_nest_lm_res %&gt;% 
  mutate(term = fct_inorder(term)) %&gt;% 
  ggplot(aes(x = neighborhood, y = estimate)) + 
  geom_point() + 
  facet_wrap(~term, nrow = 2, ncol = 2) + 
  theme(axis.text.x = element_text(angle = 80, hjust = 1, size = 5))</code></pre>
<p><img src="linear_models_files/figure-html/unnamed-chunk-13-1.png" width="90%" /></p>
<p>Really the way to fit this is a mixed model – random intercepts and slopes for each neighborhood</p>
<pre class="r"><code>manhattan_airbnb %&gt;% 
  lme4::lmer(price ~ stars + room_type + (1 + room_type | neighborhood), data = .) %&gt;% 
  broom::tidy()
## Warning in bind_rows_(x, .id): binding factor and character vector,
## coercing into character vector
## Warning in bind_rows_(x, .id): binding character and factor vector,
## coercing into character vector
## # A tibble: 11 x 5
##    term                              estimate std.error statistic group   
##    &lt;chr&gt;                                &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;   
##  1 (Intercept)                        250.        26.6      9.41  fixed   
##  2 stars                               -3.16       5.00    -0.631 fixed   
##  3 room_typePrivate room             -124.         7.80   -15.9   fixed   
##  4 room_typeShared room              -157.        12.9    -12.2   fixed   
##  5 sd_(Intercept).neighborhood         59.3       NA       NA     neighbo…
##  6 sd_room_typePrivate room.neighbo…   36.7       NA       NA     neighbo…
##  7 sd_room_typeShared room.neighbor…   43.6       NA       NA     neighbo…
##  8 cor_(Intercept).room_typePrivate…   -0.987     NA       NA     neighbo…
##  9 cor_(Intercept).room_typeShared …   -1.000     NA       NA     neighbo…
## 10 cor_room_typePrivate room.room_t…    0.992     NA       NA     neighbo…
## 11 sd_Observation.Residual            198.        NA       NA     Residual</code></pre>
</div>
<div id="binary-outcomes" class="section level3">
<h3>Binary outcomes</h3>
<p>Linear models are appropriate for outcomes that follow a continuous distribution, but binary outcomes are common. In these cases, logistic regression is a useful analytic framework.</p>
<p>The <em>Washington Post</em> has gathered data on homicides in 50 large U.S. cities and made the data available through a<a href="https://github.com/washingtonpost/data-homicides">GitHub repository</a>; the final CSV is <a href="data/homicide-data.csv">here</a>. You can read their accompanying article <a href="https://www.washingtonpost.com/graphics/2018/investigations/where-murders-go-unsolved/">here</a>. We’ll use data on unresolved murders in Baltimore, MD to illustrate logistic regression in R. The code below imports, cleans, and generally wrangles the data for analysis.</p>
<pre class="r"><code>baltimore_df = 
  read_csv(&quot;data/homicide-data.csv&quot;) %&gt;% 
  filter(city == &quot;Baltimore&quot;) %&gt;% 
  mutate(resolved = as.numeric(disposition == &quot;Closed by arrest&quot;),
         victim_age = as.numeric(victim_age),
         victim_race = fct_relevel(victim_race, &quot;White&quot;))
## Parsed with column specification:
## cols(
##   uid = col_character(),
##   reported_date = col_integer(),
##   victim_last = col_character(),
##   victim_first = col_character(),
##   victim_race = col_character(),
##   victim_age = col_character(),
##   victim_sex = col_character(),
##   city = col_character(),
##   state = col_character(),
##   lat = col_double(),
##   lon = col_double(),
##   disposition = col_character()
## )</code></pre>
<p>Using these data, we can fit a logistic regression for the binary “resolved” outcome and victim demographics as predictors. This uses the <code>glm</code> function with the family specified to account for the non-Gaussian outcome distribution.</p>
<pre class="r"><code>fit_logistic = 
  baltimore_df %&gt;% 
  glm(resolved ~ victim_age + victim_race + victim_sex, data = ., family = binomial()) </code></pre>
<p>Many of the same tools we used to work with <code>lm</code> fits can be used for <code>glm</code> fits. The table below summaries the coefficients from the model fit; because logistic model estimates are log odds ratios, we include a step to compute odds ratios as well.</p>
<pre class="r"><code>fit_logistic %&gt;% 
  broom::tidy() %&gt;% 
  mutate(OR = exp(estimate)) %&gt;%
  select(term, log_OR = estimate, OR, p.value) %&gt;% 
  knitr::kable(digits = 3)</code></pre>
<table>
<thead>
<tr class="header">
<th align="left">term</th>
<th align="right">log_OR</th>
<th align="right">OR</th>
<th align="right">p.value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">(Intercept)</td>
<td align="right">1.190</td>
<td align="right">3.287</td>
<td align="right">0.000</td>
</tr>
<tr class="even">
<td align="left">victim_age</td>
<td align="right">-0.007</td>
<td align="right">0.993</td>
<td align="right">0.027</td>
</tr>
<tr class="odd">
<td align="left">victim_raceAsian</td>
<td align="right">0.296</td>
<td align="right">1.345</td>
<td align="right">0.653</td>
</tr>
<tr class="even">
<td align="left">victim_raceBlack</td>
<td align="right">-0.842</td>
<td align="right">0.431</td>
<td align="right">0.000</td>
</tr>
<tr class="odd">
<td align="left">victim_raceHispanic</td>
<td align="right">-0.265</td>
<td align="right">0.767</td>
<td align="right">0.402</td>
</tr>
<tr class="even">
<td align="left">victim_raceOther</td>
<td align="right">-0.768</td>
<td align="right">0.464</td>
<td align="right">0.385</td>
</tr>
<tr class="odd">
<td align="left">victim_sexMale</td>
<td align="right">-0.880</td>
<td align="right">0.415</td>
<td align="right">0.000</td>
</tr>
</tbody>
</table>
<p>We can also compute fitted values; similarly to the estimates in the model summary, these are expressed as log odds and can be transformed to produce probabilities for each subject.</p>
<pre class="r"><code>baltimore_df %&gt;% 
  modelr::add_predictions(fit_logistic) %&gt;% 
  mutate(fitted_prob = boot::inv.logit(pred))
## # A tibble: 2,827 x 15
##    uid   reported_date victim_last victim_first victim_race victim_age
##    &lt;chr&gt;         &lt;int&gt; &lt;chr&gt;       &lt;chr&gt;        &lt;fct&gt;            &lt;dbl&gt;
##  1 Bal-…      20070101 NELSON      LEON         Black               17
##  2 Bal-…      20070102 GOLF        EDDIE        Black               26
##  3 Bal-…      20070105 MACKENNEY   THOMAS JOSE… Black               21
##  4 Bal-…      20070105 CANUPP      EDWARD LEE   White               61
##  5 Bal-…      20070106 CUNNINGHAN  MICHAEL      Black               46
##  6 Bal-…      20070106 ALSTON      RAY WILLIAM  Black               27
##  7 Bal-…      20070107 HENDERSON   YULE ANTONIO Black               21
##  8 Bal-…      20070108 MCDOWELL    MARCU        Black               16
##  9 Bal-…      20070108 GARDNER     RODNEY THOM… Black               21
## 10 Bal-…      20070108 BURNETTE    NELSENE      Black               44
## # ... with 2,817 more rows, and 9 more variables: victim_sex &lt;chr&gt;,
## #   city &lt;chr&gt;, state &lt;chr&gt;, lat &lt;dbl&gt;, lon &lt;dbl&gt;, disposition &lt;chr&gt;,
## #   resolved &lt;dbl&gt;, pred &lt;dbl&gt;, fitted_prob &lt;dbl&gt;</code></pre>
</div>
</div>
<div id="other-materials" class="section level2">
<h2>Other materials</h2>
<ul>
<li>This page touches on ideas that arise in several chapters on modeling in R for Data Science. These tend to assume that this is your first exposure to linear models but good reading:
<ul>
<li><a href="https://r4ds.had.co.nz/model-intro.html">Intro to modeling</a></li>
<li><a href="https://r4ds.had.co.nz/model-basics.html">Basics</a></li>
<li><a href="https://r4ds.had.co.nz/many-models.html">Many models</a></li>
</ul></li>
<li>The <code>modelr</code> package also has a <a href="https://modelr.tidyverse.org">website</a></li>
</ul>
<p>The code that I produced working examples in lecture is <a href="https://github.com/P8105/linear_models">here</a>.</p>
</div>

<br><br>
<footer>
  <img src="images/p8105_stickers.png" alt="stickers" style="width:30%">
  <br>
  <p class="copyright text-muted" align="center">Copyright &copy; 2018 Jeff Goldsmith</p>
</footer>


</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
